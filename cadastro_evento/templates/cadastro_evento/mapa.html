{% extends "cadastro_evento/base.html" %}
{% load static %}

{% block conteudo %}
<div class="content" style="padding: 0;">
    <div id="map" style="width: 100vw; height: 100vh; margin: 0; padding: 0;"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdV3seSOOBkqraltqD7TTh4U3FGC3pEC0&callback=inicializarMapa" async defer></script>

<script>
    let mapa;

    function inicializarMapa() {
        mapa = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -8.0476, lng: -34.8770 }, // Recife centro
            zoom: 12
        });

        const eventos = {{ eventos_json|safe }};

        const infoWindow = new google.maps.InfoWindow();

        eventos.forEach(evento => {
            if (evento.latitude && evento.longitude) {
                const marcador = new google.maps.Marker({
                    position: { lat: parseFloat(evento.latitude), lng: parseFloat(evento.longitude) },
                    map: mapa,
                    title: evento.titulo
                });
                
                const botaoId = `botao-saiba-mais-${evento.id}`; //Criação de um ID pro botão para resolver problema com eventos que possuem Aspas como caracteres

                const conteudo = `
                    <div style="
                        background-color: white;
                        padding: 8px;
                        border-radius: 6px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        width: 290px;
                        height: 270px;
                        font-family: Arial, sans-serif;
                    ">
                    <div style="text-align: center;">
                      <img src="${evento.imagem}" alt="${evento.nome}" style="width: 270px; height: 110px; object-fit: cover; border-radius: 4px; margin-bottom: 6px;">
                    </div>
                    <div style="text-align: left;">
                      <h3 style="margin: 0; font-size: 18px; font-weight: bold; padding-top: 10px; margin-bottom: 5px">${evento.nome}</h3>
                      <p style="margin: 4px 0; font-size: 15px; padding-top: 5px; margin-bottom: 5px; color: #808080">Data: ${evento.data}</p>
                    </div>

                    <!-- Botão Saiba mais implementado no lugar do +Detalhes (Agora não mais tão igual ao da home) -->
                    <div style="text-align: right; padding-top: 10px; margin-bottom: 5px">
                      <a;
                        id="${botaoId}"
                        class="btn btn-outline-secondary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#eventoModal">
                        Saiba Mais
                      </a>
                    </div>
        `;
        marcador.addListener('click', () => {
            infoWindow.setContent(conteudo);
            infoWindow.open(mapa, marcador);
            //Colocando aqui a correção do erro anterior de não expandir eventos que possuiam Aspas como caracteres
            google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                const botao = document.getElementById(botaoId);
                if (botao) {
                    botao.addEventListener('click', () => {
                        mostrarDetalhes(
                            evento.nome,
                            evento.descricao,
                            evento.data,
                            evento.responsavel || "Não informado",
                            evento.imagem
                        );
                    });
                }
            });
        });
    }
});

        mapa.addListener('click', () => {
            infoWindow.close();
        });
    }

    // Função que preenche o conteúdo do modal com detalhes do evento (Igual a da home)
    function mostrarDetalhes(titulo, descricao, data, responsavel, imagemUrl) {
        const conteudo = `
          <div class="row">
            <div class="col-md-8">
              <p><strong>Título:</strong> ${titulo}</p>
              <p><strong>Data:</strong> ${data}</p>
              <p><strong>Responsável:</strong> ${responsavel}</p>
              <hr>
              <p><strong>Descrição:</strong></p>
              <p>${descricao}</p>
            </div>
            <div class="col-md-4 text-center">
              <img src="${imagemUrl}" alt="Imagem do Evento" style="max-width: 100%; border-radius: 10px;">
            </div>
          </div>
        `;
        document.getElementById('eventoModalLabel').innerText = titulo;
        document.getElementById('modal-body-content').innerHTML = conteudo;
    }
</script>

<!-- Modal para exibir os detalhes do evento (Igual a da home) -->
<div class="modal fade" id="eventoModal" tabindex="-1" aria-labelledby="eventoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventoModalLabel">Detalhes do Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="modal-body-content">
        <!-- Conteúdo dinâmico será inserido via JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap CSS e JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></>

{% endblock %}