{% extends "cadastro_evento/base.html" %}
{% block conteudo %}
<div class="content">
  <h2 class="mb-4">Editar Evento</h2>

  <form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
      <!-- Coluna esquerda -->
      <div class="col-md-6">
        <div class="card form-section mb-3">
          <h5>Informações Básicas</h5>

          <div class="mb-2">
            <label class="form-label">Título</label>
            <input name="titulo" type="text" class="form-control form-control-sm" value="{{ evento.titulo }}" required>
          </div>

          <div class="mb-2">
            <label class="form-label">Responsável</label>
            <select name="responsavel" class="form-select form-select-sm" required>
              <option value="">Selecione</option>
              <option value="Secretaria de Turismo" {% if evento.responsavel == "Secretaria de Turismo" %}selected{% endif %}>Secretaria de Turismo</option>
              <option value="Secretaria de Cultura" {% if evento.responsavel == "Secretaria de Cultura" %}selected{% endif %}>Secretaria de Cultura</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Local</label>
            <input id="autocomplete" name="local" type="text" class="form-control form-control-sm" value="{{ evento.local }}" required>
            <input type="hidden" id="latitude" name="latitude" value="{{ evento.latitude }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ evento.longitude }}">
          </div>

          <div class="mb-2">
            <label class="form-label">Descrição</label>
            <textarea name="descricao" class="form-control form-control-sm" rows="2">{{ evento.descricao }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Data</label>
            <input name="data" type="date" class="form-control form-control-sm" value="{{ evento.data|date:'Y-m-d' }}" required>
          </div>

          <div class="mb-2">
            <label class="form-label">Atrações</label>
            <input name="atracoes" type="text" class="form-control form-control-sm" value="{{ evento.atracoes }}">
          </div>

          <div class="mb-2">
            <label class="form-label">Orçamento Estimado</label>
            <input 
              id="orcamento_mascara" 
              type="text" 
              class="form-control form-control-sm" 
              placeholder="R$ 0,00"
              value="R$ {{ evento.orcamento_estimado|stringformat:'.2f'|cut:'.'|slice:':-2'|add:','|add:evento.orcamento_estimado|stringformat:'.2f'|slice:'-2:' }}">
            <input 
              id="orcamento_real" 
              name="orcamento_estimado" 
              type="hidden" 
              value="{{ evento.orcamento_estimado }}">
          </div>

          <script>
            document.getElementById('orcamento_mascara').addEventListener('input', function(e) {
              let value = e.target.value.replace(/\D/g, '');
              value = value.replace(/^0+/, '');
              if (value.length < 3) value = value.padStart(3, '0');
              let integer = value.slice(0, -2);
              let decimal = value.slice(-2);
              let formatted = integer.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ',' + decimal;
              e.target.value = 'R$ ' + formatted;
              document.getElementById('orcamento_real').value = (parseInt(value) / 100).toFixed(2);
            });
          </script>

          <div class="mb-2">
            <label class="form-label">Programação</label>
            <textarea name="programacao" class="form-control form-control-sm" rows="2">{{ evento.programacao }}</textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Imagem do Evento</label>
            <input name="imagem" type="file" class="form-control">
            {% if evento.imagem %}
              <img src="{{ evento.imagem.url }}" class="img-thumbnail mt-2" width="200">
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Coluna direita -->
      <div class="col-md-6">
        <div class="card form-section mb-3">
          <h5>Recursos</h5>

          <div class="mb-2">
            <label class="form-label">Equipamento</label>
            <textarea name="equipamento" class="form-control form-control-sm" rows="2">{{ evento.equipamento }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Fornecedores</label>
            <textarea name="fornecedores" class="form-control form-control-sm" rows="2">{{ evento.fornecedores }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Patrocinadores</label>
            <textarea name="patrocinadores" class="form-control form-control-sm" rows="2">{{ evento.patrocinadores }}</textarea>
          </div>
        </div>

        <div class="card form-section mb-3">
          <h5>Outros</h5>

          <div class="mb-2">
            <label class="form-label">Contratações</label>
            <textarea name="contratacoes" class="form-control form-control-sm" rows="2">{{ evento.contratacoes }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Estruturas</label>
            <textarea name="estruturas" class="form-control form-control-sm" rows="2">{{ evento.estruturas }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Marketing</label>
            <input name="marketing" type="text" class="form-control form-control-sm" value="{{ evento.marketing }}">
          </div>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
  </form>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdV3seSOOBkqraltqD7TTh4U3FGC3pEC0&libraries=places&callback=initAutocomplete" async defer></script>

  <script>
    function initAutocomplete() {
      const input = document.getElementById('autocomplete');
      const autocomplete = new google.maps.places.Autocomplete(input);

      autocomplete.addListener('place_changed', function () {
        const place = autocomplete.getPlace();
        if (place.geometry) {
          document.getElementById('latitude').value = place.geometry.location.lat();
          document.getElementById('longitude').value = place.geometry.location.lng();
        }
      });
    }
  </script>
</div>
{% endblock %}
